---
title: "Analysis of German publication output"
author: "Anne Hobert"
date: "3/6/2020"
output: github_document
---

```{r, echo = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  fig.width = 6,
  fig.asp = 0.618,
  out.width = "90%",
  fig.align = "center",
  dpi = 300
)
```

```{r}
library(tidyverse)
library(urltools)
library(cowplot)
library(viridis)
```

## Data

In this document we describe the analysis of our sample of publications from German research institutions. We work with the dataset `pubs_cat` generated in [data_gathering.Rmd](data_gathering.Rmd).

```{r}
pubs_cat <- readr::read_csv("data/pubs_cat.csv", col_types = "dcdcclcc")
```

The goal is to answer the three research questions 

1) Has the OA fraction of the publication output of German universities and research institutions increased constantly over time?
2) Which OA type is the most prevalent OA approach and can we identify different patterns of adoption to OA?
3) Can we observe differences between the research sectors of the German science system? Are there obvious explanations for this (like different missions or subject profiles?


## National level

First, we look at the highest aggregation level, namely the national level. Here, publications of all institutions of the selected sectors (5+2) are counted per year and category. 

### by host type

The first figure shows the development over time of the total number of publications per host type, that is, we collate all articles where access is provided via a publisher based platform as `OA (publisher)`, all repository based OA is collated as `OA (repository)`, and all remaining articles are labelled as `Not OA`.

```{r}
pubs_cat %>% 
  mutate(oa_category = fct_relevel(factor(oa_category), "full_oa_journal", "other_oa_journal", "opendoar_inst", "opendoar_subject", "opendoar_other", "other_repo", "not_oa")) %>% 
  mutate(oa_category = fct_collapse(oa_category,
    journal_oa = c("full_oa_journal", "other_oa_journal"),
    repo_oa = c("opendoar_inst", "opendoar_subject", "opendoar_other", "other_repo")
  )) %>% 
  group_by(PUBYEAR, oa_category) %>% 
  summarise(number_of_articles = n_distinct(PK_ITEMS)) %>% 
  ggplot(aes(x = PUBYEAR, y = number_of_articles)) +
    #geom_line(aes(color = oa_category)) +
    geom_col(aes(fill = oa_category), position = "dodge") +
    # geom_bar(aes(fill = oa_category), stat = "identity", position = "dodge") +
    #scale_color_viridis(end = 0.85, discrete = TRUE, direction = -1) +
    scale_fill_viridis(end = 0.95, discrete = TRUE, direction = -1, name = "OA Categories", labels = c("OA (publisher)", "OA (repository)", "Not OA")) +
    labs(x = "Publication Year", y = "Number of Articles", title = "Number of Articles per OA host type (national level)") +
    theme(legend.position = "bottom")
```

In comparison to all articles published:

```{r}
all_articles <- pubs_cat%>% 
  group_by(PUBYEAR) %>% 
  summarise(number_of_articles = n_distinct(PK_ITEMS))

pubs_cat %>% 
  mutate(oa_category = fct_relevel(factor(oa_category), "full_oa_journal", "other_oa_journal", "opendoar_inst", "opendoar_subject", "opendoar_other", "other_repo", "not_oa")) %>% 
  mutate(oa_category = fct_collapse(oa_category,
    journal_oa = c("full_oa_journal", "other_oa_journal"),
    repo_oa = c("opendoar_inst", "opendoar_subject", "opendoar_other", "other_repo"),
    not_oa = "not_oa"
  ))  %>% 
  group_by(PUBYEAR, oa_category) %>% 
  summarise(number_of_articles = n_distinct(PK_ITEMS)) %>% 
#  .$oa_category %>% levels()
  ggplot(aes(x = PUBYEAR, y = number_of_articles)) +
    geom_col(data = all_articles, aes(color = "All Articles"), fill = "#b3b3b3", size = 0.05) +
    scale_color_manual(values = "#ffffff", name = "", labels = "All Articles") +
    geom_col(aes(fill = oa_category)) +
    scale_fill_viridis(end = 0.95, discrete = TRUE, direction = -1, name = "", labels = c("OA (publisher)", "OA (repository)", "Not OA"))+
    facet_wrap(~ oa_category, nrow = 1) +
    theme(strip.text.x = element_blank()) +
    labs(x = "Publication Year", y = "Number of Articles", title = "Number of Articles per OA host type (national level)") +
    theme(legend.position = "bottom")
```


Looking at proportions:

```{r}
pubs_cat %>% 
  group_by(PUBYEAR) %>% 
  mutate(n_total = n_distinct(PK_ITEMS)) %>% 
  ungroup() %>% 
  mutate(oa_category = fct_relevel(factor(oa_category), "full_oa_journal", "other_oa_journal", "opendoar_inst", "opendoar_subject", "opendoar_other", "other_repo", "not_oa")) %>% 
  mutate(oa_category = fct_collapse(oa_category,
    journal_oa = c("full_oa_journal", "other_oa_journal"),
    repo_oa = c("opendoar_inst", "opendoar_subject", "opendoar_other", "other_repo")
  )) %>% 
  group_by(PUBYEAR, oa_category, n_total) %>% 
  summarise(number_of_articles = n_distinct(PK_ITEMS)) %>%
  mutate(prop = number_of_articles / n_total * 100) %>% 
  ggplot(aes(x = PUBYEAR, y = prop)) +
    #geom_line(aes(color = oa_category)) +
    geom_col(aes(fill = oa_category), position = "dodge") +
    # geom_bar(aes(fill = oa_category), stat = "identity", position = "dodge") +
    #scale_color_viridis(end = 0.85, discrete = TRUE, direction = -1) +
    scale_fill_viridis(end = 0.95, discrete = TRUE, labels = c("OA (publisher)", "OA (repository)", "Not OA"), direction = -1) +
    labs(x = "Publication Year", y = "Proportion of Articles (in %)", title = "Proportion of Articles per OA host type", fill = "OA Category") +
    theme(legend.position = "right") 
    # theme(axis.title = element_text(size = 16),
    #     plot.title = element_text(size = 24),
    #     axis.text = element_text(size = 14),
    #     legend.text = element_text(size = 14),
    #     legend.title = element_text(size = 16))
```

As faceted graph:

```{r}
pubs_cat %>% 
  group_by(PUBYEAR) %>% 
  mutate(n_total = n_distinct(PK_ITEMS)) %>% 
  ungroup() %>% 
  mutate(oa_category = fct_relevel(factor(oa_category), "full_oa_journal", "other_oa_journal", "opendoar_inst", "opendoar_subject", "opendoar_other", "other_repo", "not_oa")) %>% 
  mutate(oa_category = fct_collapse(oa_category,
    journal_oa = c("full_oa_journal", "other_oa_journal"),
    repo_oa = c("opendoar_inst", "opendoar_subject", "opendoar_other", "other_repo")
  )) %>% 
  group_by(PUBYEAR, oa_category, n_total) %>% 
  summarise(number_of_articles = n_distinct(PK_ITEMS)) %>%
  mutate(prop = number_of_articles / n_total * 100) %>% 
  ggplot(aes(x = PUBYEAR, y = prop)) +
    #geom_line(aes(color = oa_category)) +
    geom_col(aes(fill = oa_category)) +
    scale_fill_viridis(end = 0.95, discrete = TRUE, labels = c("OA (publisher)", "OA (repository)", "Not OA"), direction = -1) +
    facet_wrap(~ oa_category, nrow = 1) +
    theme(strip.text.x = element_blank()) +
    labs(x = "Publication Year", y = "Proportion of Articles (in %)", title = "Proportion of Articles per OA host type", fill = "OA Category") +
    theme(legend.position = "bottom")
```

### by OA category

The following figure shows very similar data as the one before - only that here, all OA categories from the schema are shown individually, that is, publisher based and repository based OA are further distinguished into subgroups.

```{r}
pubs_cat %>% 
  group_by(PUBYEAR, oa_category) %>% 
  summarise(number_of_articles = n_distinct(PK_ITEMS)) %>% 
  mutate(oa_category = fct_relevel(factor(oa_category), "full_oa_journal", "other_oa_journal", "opendoar_inst", "opendoar_subject", "opendoar_other", "other_repo", "not_oa")) %>% 
  ggplot(aes(x = PUBYEAR, y = number_of_articles)) +
    geom_line(aes(color = oa_category), size = 1) +
    #geom_col(aes(fill = oa_category), position = "dodge") +
    # geom_bar(aes(fill = oa_category), stat = "identity", position = "dodge") +
    #scale_fill_viridis(end = 0.95, discrete = TRUE, direction = -1) +
    scale_color_viridis(end = 0.95, discrete = TRUE, direction = -1, name= "OA category") +
    labs(x = "Publication Year", y = "Number of Articles", title = "Number of Articles per OA category (national level)") +
    theme(legend.position = "right")
```

In comparison to all articles published:

```{r}
all_articles <- pubs_cat%>% 
  group_by(PUBYEAR) %>% 
  summarise(number_of_articles = n_distinct(PK_ITEMS))

pubs_cat %>% 
  mutate(oa_category = fct_relevel(factor(oa_category), "full_oa_journal", "other_oa_journal", "opendoar_inst", "opendoar_subject", "opendoar_other", "other_repo", "not_oa")) %>% 
  group_by(PUBYEAR, oa_category) %>% 
  summarise(number_of_articles = n_distinct(PK_ITEMS)) %>% 
#  .$oa_category %>% levels()
  ggplot(aes(x = PUBYEAR, y = number_of_articles)) +
    geom_col(data = all_articles, aes(color = "All Articles"), fill = "#b3b3b3", size = 0.05) +
    scale_color_manual(values = "#ffffff", name = "", labels = "All Articles") +
    geom_col(aes(fill = oa_category)) +
    scale_fill_viridis(end = 0.95, discrete = TRUE, direction = -1, name = "OA categories")+
    facet_wrap(~ oa_category, ncol = 2) +
    theme(strip.text.x = element_blank()) +
    labs(x = "Publication Year", y = "Number of Articles", title = "Number of Articles per OA host type (national level)") +
    theme(legend.position = "right")
```

Looking at proportions, we get:

```{r}
pubs_cat %>% 
  group_by(PUBYEAR) %>% 
  mutate(n_total = n_distinct(PK_ITEMS)) %>% 
  ungroup() %>% 
  mutate(oa_category = fct_relevel(factor(oa_category), "full_oa_journal", "other_oa_journal", "opendoar_inst", "opendoar_subject", "opendoar_other", "other_repo", "not_oa")) %>% 
  group_by(PUBYEAR, oa_category, n_total) %>% 
  summarise(number_of_articles = n_distinct(PK_ITEMS)) %>% 
  mutate(prop = number_of_articles / n_total * 100) %>% 
  ggplot(aes(x = PUBYEAR, y = prop)) +
    #geom_line(aes(color = oa_category), size = 1) +
    geom_col(aes(fill = oa_category), position = "dodge") +
    scale_fill_viridis(end = 0.95, discrete = TRUE, direction = -1, name = "OA category") +
    labs(x = "Publication Year", y = "Proportion of Articles (in %)", title = "Proportion of Articles per OA category (national level)") +
    theme(legend.position = "bottom")
```

As faceted graph:

```{r}
pubs_cat %>% 
  group_by(PUBYEAR) %>% 
  mutate(n_total = n_distinct(PK_ITEMS)) %>% 
  ungroup() %>% 
  mutate(oa_category = fct_relevel(factor(oa_category), "full_oa_journal", "other_oa_journal", "opendoar_inst", "opendoar_subject", "opendoar_other", "other_repo", "not_oa")) %>% 
  group_by(PUBYEAR, oa_category, n_total) %>% 
  summarise(number_of_articles = n_distinct(PK_ITEMS)) %>%
  mutate(prop = number_of_articles / n_total * 100) %>% 
  ggplot(aes(x = PUBYEAR, y = prop)) +
    #geom_line(aes(color = oa_category)) +
    geom_col(aes(fill = oa_category)) +
    scale_fill_viridis(end = 0.95, discrete = TRUE, direction = -1, name = "OA category") +
    facet_wrap(~ oa_category, ncol = 2) +
    theme(strip.text.x = element_blank()) +
    labs(x = "Publication Year", y = "Proportion of Articles (in %)", title = "Proportion of Articles per OA host type", fill = "OA Category") +
    theme(legend.position = "right")
```

## Level of sectors

Next, we go one level down and look at how the separate sectors developed.

Number of OA articles per sector in comparison to all articles published within the sector:

```{r, fig.asp=1}
pubs_cat %>% 
  mutate(oa_category = fct_relevel(factor(oa_category), "full_oa_journal", "other_oa_journal", "opendoar_inst", "opendoar_subject", "opendoar_other", "other_repo", "not_oa")) %>% 
  mutate(oa_category = fct_collapse(oa_category,
    is_oa = c("full_oa_journal", "other_oa_journal", "opendoar_inst", "opendoar_subject", "opendoar_other", "other_repo"),
    not_oa = "not_oa"
  ))  %>%
  group_by(sector, PUBYEAR, oa_category) %>% 
  summarise(number_of_articles = n_distinct(PK_ITEMS)) %>% 
  ggplot(aes(x = PUBYEAR, y = number_of_articles)) +
    geom_area(aes(fill = fct_rev(oa_category), group = fct_rev(oa_category)),  alpha = 0.8) +
    scale_fill_manual(values = c("#b3b3b3a0", "#56B4E9"), name = "Is OA?", labels = c("Not OA", "OA"))+
    facet_wrap(~ sector, scales = "free", ncol = 2) +
    labs(x = "Publication Year", y = "Number of Articles", title = "Number of OA Articles (level of sectors)") +
    theme(legend.position = "right")
```

### by host type

The first figure depicts the number of publications per host type category over time for each sector.

```{r, fig.asp=1}
#, fig.asp=1.5}
pubs_cat %>% 
  mutate(oa_category = factor(oa_category, levels = c("full_oa_journal", "other_oa_journal", "opendoar_inst", "opendoar_subject", "opendoar_other", "other_repo", "not_oa"))) %>% 
  mutate(oa_category = fct_collapse(oa_category,
    journal_oa = c("full_oa_journal", "other_oa_journal"),
    repo_oa = c("opendoar_inst", "opendoar_subject", "opendoar_other", "other_repo"),
    not_oa = "not_oa"
  )) %>% 
  group_by(sector, PUBYEAR, oa_category) %>% 
  summarise(number_of_articles = n_distinct(PK_ITEMS)) %>%
  ggplot(aes(x = PUBYEAR, y = number_of_articles)) +
    geom_col(aes(fill = oa_category), position = "dodge") +
    facet_wrap(~ sector, scales = "free", ncol = 2) +
    scale_fill_viridis(end = 0.95, discrete = TRUE, direction = -1, name = "OA category", labels = c("OA (publisher)", "OA (repository)", "Not OA")) +
    labs(x = "Publication Year", y = "Number of Articles", title = "Number of Articles per OA host type (level of sectors)", color = "oa_category") +
    theme(legend.position = "right")
```

Looking at proportions:
```{r, fig.asp=1}
#, fig.asp=1.5}
pubs_cat %>%
  group_by(PUBYEAR, sector) %>% 
  mutate(n_total = n_distinct(PK_ITEMS)) %>% 
  ungroup() %>% 
  mutate(oa_category = factor(oa_category, levels = c("full_oa_journal", "other_oa_journal", "opendoar_inst", "opendoar_subject", "opendoar_other", "other_repo", "not_oa"))) %>% 
  mutate(oa_category = fct_collapse(oa_category,
    journal_oa = c("full_oa_journal", "other_oa_journal"),
    repo_oa = c("opendoar_inst", "opendoar_subject", "opendoar_other", "other_repo"),
    not_oa = "not_oa"
  )) %>% 
  group_by(sector, PUBYEAR, oa_category, n_total) %>% 
  summarise(number_of_articles = n_distinct(PK_ITEMS)) %>%
  mutate(prop = number_of_articles / n_total *100) %>% 
  ggplot(aes(x = PUBYEAR, y = prop)) +
    geom_col(aes(fill = oa_category), position = "dodge") +
    facet_wrap(~ sector, scales = "free") +
    scale_fill_viridis(end = 0.95, discrete = TRUE, direction = -1, name = "OA category", labels = c("OA (publisher)", "OA (repository)", "Not OA")) +
    labs(x = "Publication Year", y = "Proportion of Articles (in %)", title = "Proportion of Articles per OA host type (level of sectors)", color = "oa_category") +
    theme(legend.position = "bottom")
```

Facet grid:

```{r, fig.asp=1}
pubs_cat_abbr <- pubs_cat %>% 
  mutate(sector = case_when(
    sector == "Hochschulen" ~ "HS",
    sector == "Leibniz-Gemeinschaft" ~ "LG",
    sector == "Helmholtz-Gemeinschaft" ~ "HG",
    sector == "Max-Planck-Gesellschaft" ~ "MPG",
    sector == "Ressortforschung-Bund" ~ "R-B",
    sector == "Ressortforschung-Länder" ~ "R-L",
    sector == "Fraunhofer-Gesellschaft" ~ "FG"
  ))
pubs_cat_abbr %>%
  group_by(PUBYEAR, sector) %>% 
  mutate(n_total = n_distinct(PK_ITEMS)) %>% 
  ungroup() %>% 
  mutate(oa_category = factor(oa_category, levels = c("full_oa_journal", "other_oa_journal", "opendoar_inst", "opendoar_subject", "opendoar_other", "other_repo", "not_oa"))) %>%
    mutate(oa_category = fct_collapse(oa_category,
    journal_oa = c("full_oa_journal", "other_oa_journal"),
    repo_oa = c("opendoar_inst", "opendoar_subject", "opendoar_other", "other_repo"),
    not_oa = "not_oa"
  )) %>% 
  group_by(sector, PUBYEAR, oa_category, n_total) %>% 
  summarise(number_of_articles = n_distinct(PK_ITEMS)) %>%
  mutate(prop = number_of_articles / n_total * 100) %>% 
  ggplot(aes(x = PUBYEAR, y = prop)) +
    geom_col(aes(fill = oa_category)) +
    facet_grid(sector ~ oa_category) +
    theme(strip.text.x = element_blank()) +
    scale_fill_viridis(end = 0.95, discrete = TRUE, direction = -1, name = "OA category", labels = c("OA (publisher)", "OA (repository)", "Not OA")) +
    labs(x = "Publication Year", y = "Proportion of Articles (in %)", title = "Proportion of Articles per OA host type (level of sectors)", color = "oa_category") +
    theme(legend.position = "bottom")
```

### by OA category

Distinguishing all the single OA categories:

```{r, fig.asp=1}
pubs_cat %>%
  mutate(oa_category = factor(oa_category, levels = c("full_oa_journal", "other_oa_journal", "opendoar_inst", "opendoar_subject", "opendoar_other", "other_repo", "not_oa"))) %>% 
  group_by(sector, PUBYEAR, oa_category) %>% 
  summarise(number_of_articles = n_distinct(PK_ITEMS)) %>%
  ggplot(aes(x = PUBYEAR, y = number_of_articles)) +
    geom_col(aes(fill = oa_category), position = "dodge") +
    facet_wrap(~ sector, scales = "free", ncol = 2) +
    scale_fill_viridis(end = 0.95, discrete = TRUE, direction = -1, name = "OA category") +
    labs(x = "Publication Year", y = "Number of Articles", title = "Number of Articles per OA category (level of sectors)", color = "oa_category") +
    theme(legend.position = "bottom")
```

Looking at proportions:

```{r, fig.asp=1}
pubs_cat %>%
  group_by(PUBYEAR, sector) %>% 
  mutate(n_total = n_distinct(PK_ITEMS)) %>% 
  ungroup() %>% 
  mutate(oa_category = factor(oa_category, levels = c("full_oa_journal", "other_oa_journal", "opendoar_inst", "opendoar_subject", "opendoar_other", "other_repo", "not_oa"))) %>% 
  group_by(sector, PUBYEAR, oa_category, n_total) %>% 
  summarise(number_of_articles = n_distinct(PK_ITEMS)) %>%
  mutate(prop = number_of_articles / n_total * 100) %>% 
  ggplot(aes(x = PUBYEAR, y = prop)) +
    geom_col(aes(fill = oa_category), position = "dodge") +
    facet_wrap(~ sector, scales = "free", ncol = 2) +
    scale_fill_viridis(end = 0.95, discrete = TRUE, direction = -1, name = "OA category") +
    labs(x = "Publication Year", y = "Proportion of Articles (in %)", title = "Proportion of Articles per OA category (level of sectors)", color = "oa_category") +
    theme(legend.position = "bottom")
```


Facet grid:

```{r, fig.asp=1.2}
pubs_cat_abbr <- pubs_cat %>% 
  mutate(sector = case_when(
    sector == "Hochschulen" ~ "HS",
    sector == "Leibniz-Gemeinschaft" ~ "LG",
    sector == "Helmholtz-Gemeinschaft" ~ "HG",
    sector == "Max-Planck-Gesellschaft" ~ "MPG",
    sector == "Ressortforschung-Bund" ~ "R-B",
    sector == "Ressortforschung-Länder" ~ "R-L",
    sector == "Fraunhofer-Gesellschaft" ~ "FG"
  ))
pubs_cat_abbr %>%
  group_by(PUBYEAR, sector) %>% 
  mutate(n_total = n_distinct(PK_ITEMS)) %>% 
  ungroup() %>% 
  mutate(oa_category = factor(oa_category, levels = c("full_oa_journal", "other_oa_journal", "opendoar_inst", "opendoar_subject", "opendoar_other", "other_repo", "not_oa"))) %>%
  group_by(sector, PUBYEAR, oa_category, n_total) %>% 
  summarise(number_of_articles = n_distinct(PK_ITEMS)) %>%
  mutate(prop = number_of_articles / n_total * 100) %>% 
  ggplot(aes(x = PUBYEAR, y = prop)) +
    geom_col(aes(fill = oa_category)) +
    facet_grid(sector ~ oa_category) +
    theme(strip.text.x = element_blank()) +
    scale_fill_viridis(end = 0.95, discrete = TRUE, direction = -1, name = "OA category") +
    labs(x = "Publication Year", y = "Proportion of Articles (in %)", title = "Proportion of Articles per OA category (level of sectors)", color = "oa_category") +
    theme(legend.position = "bottom")
```

## Institutional level

Lastly, we go down to the institutional level. Since there are more than 400 institutions in the dataset, we do not want to present figures for individual institutions. Instead, we want to show the variety of open access shares and strategies. To this end, we first calculate the individual OA shares.

```{r}
oa_shares <- pubs_cat %>%
  mutate(oa_category = factor(oa_category, levels = c("full_oa_journal", "other_oa_journal", "opendoar_inst", "opendoar_subject", "opendoar_other", "other_repo", "not_oa"))) %>% 
  mutate(oa_category = fct_collapse(oa_category,
    is_oa = c("full_oa_journal", "other_oa_journal", "opendoar_inst", "opendoar_subject", "opendoar_other", "other_repo"),
    not_oa = "not_oa"
  )) %>% 
  group_by(INST_NAME) %>% 
  mutate(n_total = n_distinct(PK_ITEMS)) %>% 
  ungroup() %>%
  group_by(INST_NAME, oa_category, n_total) %>% 
  summarise(n_cat = n_distinct(PK_ITEMS)) %>% 
  pivot_wider(names_from = oa_category,
              values_from = n_cat,
              values_fill = list(n_cat = 0)) %>% 
  mutate(oa_share = is_oa/n_total *100) %>%
  rename(n_oa = is_oa, n_not_oa = not_oa) %>% 
  ungroup()
```

We now display the variability among institutions per sector with respect to the total publication output.

```{r, fig.asp=1}
pubs_cat %>%
  mutate(oa_category = factor(oa_category, levels = c("full_oa_journal", "other_oa_journal", "opendoar_inst", "opendoar_subject", "opendoar_other", "other_repo", "not_oa"))) %>% 
  mutate(oa_category = fct_collapse(oa_category,
    journal_oa = c("full_oa_journal", "other_oa_journal"),
    repo_oa = c("opendoar_inst", "opendoar_subject", "opendoar_other", "other_repo"),
    not_oa = "not_oa"
  )) %>% 
  left_join(oa_shares, by = 'INST_NAME') %>% 
  group_by(sector, INST_NAME, n_total, oa_share) %>%
  summarise() %>% 
  ggplot(aes(x = n_total, y = oa_share)) +
    geom_point(aes(color = sector)) + 
    scale_x_log10() + 
    scale_color_viridis(end = 0.95, direction = -1, option = "plasma", discrete = TRUE, name = "Sectors")+
    facet_wrap(~ sector, ncol = 2) +
    labs(x = "Total publication output (logarithmic scale)", y = "OA share (in %)", title = "Open Access shares of research institutions in Germany") +
    theme(legend.position = "right")
```

Sectorwise comparison of OA shares

```{r, fig.asp=0.8}
pubs_cat %>%
  left_join(oa_shares, by = 'INST_NAME') %>%
  group_by(INST_NAME, sector, oa_share, n_total) %>% 
  summarise() %>% 
  group_by(sector) %>% 
  summarise_at(vars(n_total, oa_share), funs(min, max, mean, median,sd)) %>% 
  select(sector, starts_with('oa_share'), starts_with('n_total'))

n_fun <- function(x){
  return(data.frame(y = 105,
                    label = paste ("n=", length(x))))
}

pubs_cat %>%
  group_by(sector) %>% 
  mutate(n_sector = n_distinct(PK_ITEMS),
         sector_cat = case_when(
           n_sector > 500000 ~ 'high_n_pubs',
           n_sector > 50000 ~ 'middle_n_pubs',
           TRUE ~ 'low_n_pubs'
         )) %>% 
  ungroup() %>% 
  left_join(oa_shares, by = 'INST_NAME') %>%
  group_by(INST_NAME, sector, oa_share, sector_cat) %>% 
  summarise() %>% 
  ggplot(aes(x = sector, y = oa_share)) + 
    geom_boxplot(aes(color = sector_cat), varwidth = TRUE, size = 1) +
#    geom_boxplot() +
 #   stat_summary(fun.data = n_fun, geom = "text", hjust = 0.5) +
    geom_jitter(alpha = 0.1) +
    scale_color_viridis(end = 0.8, labels = c("high", "medium", "low"), discrete = TRUE, direction = -1, option = "plasma")+
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    labs(title = "OA shares of institutions per sector", x = "", y = "OA share (in %)", color = "Publication output",
         caption = "Widths of the boxes corresponds to the number of institutions per sector,\n gray points display oa shares for individual institutions.") 
      # theme(axis.title = element_text(size = 24),
      #   plot.title = element_text(size = 36),
      #   axis.text = element_text(size = 21),
      #   legend.text = element_text(size = 21),
      #   legend.title = element_text(size = 24))
```
